<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.6 at 2019-09-22 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>SimpleStub &#x2013; SimpleStub: Handling System Properties</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20190922" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                SimpleStub
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2019-09-22</span>
                  &nbsp;| <span id="projectVersion">Version: 1.3.0</span>
                      </div>
            <div class="xright">                    <a href="./" title="SimpleStub">SimpleStub</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Description</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="started.html" title="Getting Started">Getting Started</a>
            </li>
                  <li class="none">
                          <a href="additional.html" title="Additional Use Cases">Additional Use Cases</a>
            </li>
                  <li class="none">
                          <a href="statics.html" title="Handling static variables">Handling static variables</a>
            </li>
                  <li class="none">
            <strong>Handling system properties</strong>
          </li>
                  <li class="none">
                          <a href="classloaders.html" title="Handling class loaders">Handling class loaders</a>
            </li>
                  <li class="none">
                          <a href="filesystem.html" title="Simulating files in memory">Simulating files in memory</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                        <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        


<div class="section">
<h2><a name="Handling_System_Properties"></a>Handling System Properties</h2>


<p>It sometimes happens that a class will manipulate or depend on system properties. Since we always want to restore
    conditions to what they were before a unit test, SimpleStub provides support for manipulating them in a reversible
    way.
</p>


<p>
    One place where this can be useful is JNDI, where the call to <tt>new InitialContext()</tt> uses a factory
    defined by the property <tt>java.naming.factory.initial</tt>, defined by the constant
    <a class="externalLink" href="http://docs.oracle.com/javase/8/docs/api/javax/naming/Context.html#INITIAL_CONTEXT_FACTORY."><tt>javax.naming.Context.INITIAL_CONTEXT_FACTORY</tt></a>.
    Testing code that uses JNDI can often be simplified is we can substitute a test factory.
</p>


<p>The first thing we do is to define an appropriate Context stub class. In this case, our test will only do lookups, so
    that is all that we implement:</p>


    
<div class="source">
<pre>
<b>abstract static class</b> ContextStub <b>implements</b> javax.naming.Context {
    <b>private static </b> Map&lt;String, Object&gt; map = new HashMap&lt;&gt;();

    <b>static void</b> clear() { map.clear(); }

    <b>static void</b> defineEntry(String name, Object value) { map.put(name, value); }

    <i>@Override</i>
    <b>public Object</b> lookup(String name) throws NamingException {
        <b>if</b> (!map.containsKey(name)) throw <b>new</b> NamingException(&quot;failed in test&quot;);
        <b>return</b> map.get(name);
    }
}</pre></div>


<p>
    Then we define the initial context factory itself, along with methods to activate it and clean up afterwards.
</p>

    
<div class="source">
<pre>
<b>static class</b> InitialContextFactoryStub <b>implements</b> javax.naming.spi.InitialContextFactory {
    <b>private static </b> Memento memento = Memento.NULL;

    <b>static void</b> install() {
        ContextStub.clear();
        memento = SystemPropertySupport.install(Context.INITIAL_CONTEXT_FACTORY, InitialContextFactoryStub<b>.class</b>.getName());
    }

    <b>static void</b> uninstall() {
        memento.revert();
    }

    <i>@Override</i>
    <b>public</b> Context getInitialContext(Hashtable&lt;?,?&gt; environment) throws NamingException {
        return createStub(ContextStub<b>.class</b>);
    }

}</pre></div>



<p>Note that when we install the factory, we also clear all current definitions. This prevents one test from affecting others.
    Now we can use this in a test:</p>


    
<div class="source">
<pre>
    <i>@Before</i>
    <b>public void</b> setUp() <b>throws</b> Exception {
        InitialContextFactoryStub.install();
    }

    <i>@After</i>
    <b>public void</b> tearDown() {
        InitialContextFactoryStub.uninstall();
    }

    <i>@Test</i>
    <b>public void</b> whenJndiValueIsString_reportValue() {
        ContextStub.defineEntry(computer.VALUE_NAME, &quot;zork&quot;);

        assertThat(computer.getValue(), is(&quot;zork&quot;));
    }

    <i>@Test</i>
    <b>public void</b> whenJndiValueIsBoolean_reportValue() {
         ContextStub.defineEntry(computer.VALUE_NAME, Boolean.TRUE);

         assertThat(computer.getValue(), is(&quot;asserted&quot;));
     }</pre></div>



<p>thus verifying that the <tt>getValue</tt> method is looking up the value named VALUE_NAME and converting it appropriately.</p>


</div>

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              <?xml version="1.0" encoding="UTF-8"?>
<footer>Copyright &amp;copy; 2012-2019, Russell Gold. All Rights Reserved.</footer>
            </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>