<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/xhtml/classloaders.xhtml at 2022-07-21 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>SimpleStub &#x2013; SimpleStub: Handling Class-loaders</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
    
  </head>
  <body class="composite">
    <div id="banner">
<div id="bannerLeft">
SimpleStub
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2022-07-21</span>
          &nbsp;| <span id="projectVersion">Version: 1.3.2</span>
      </div>
      <div class="xright"><a href="./" title="SimpleStub">SimpleStub</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Description</h5>
    <ul>
     <li class="none"><a href="index.html" title="Overview">Overview</a></li>
     <li class="none"><a href="started.html" title="Getting Started">Getting Started</a></li>
     <li class="none"><a href="additional.html" title="Additional Use Cases">Additional Use Cases</a></li>
     <li class="none"><a href="statics.html" title="Handling static variables">Handling static variables</a></li>
     <li class="none"><a href="properties.html" title="Handling system properties">Handling system properties</a></li>
     <li class="none"><strong>Handling class loaders</strong></li>
     <li class="none"><a href="filesystem.html" title="Simulating files in memory">Simulating files in memory</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">



<div class="section">
<h2><a name="Handling_Class-loaders"></a>Handling Class-loaders</h2>


<p>Some servers separate classes according to multiple class-loaders, with each thread having its own. Testing the
    behavior of such systems often setting the thread context class-loader and having code attempt to load classes from it.
    SimpleStub provides support for safely setting the thread context class-loader and priming it with test classes.
</p>

<p>
    The following example tests some behavior of the <tt>Reader</tt> class. This class reads serialized data from
    an input stream, using the thread context class-loader to find any application-specific classes. Any class which
    implements the <tt>Tagged</tt> interface will have its <tt>applicationName</tt> property set to the
    corresponding property from its classloader (which also implements that interface).
</p>


<p>We'll start by creating a setup class:</p>

    
        
<div class="source">
<pre>
    <b>abstract static class</b> ClassLoaderControl {
        <b>private</b> Memento memento = Memento.NULL;

        <b>static void</b> install() <b>throws</b> NoSuchFieldException {
            memento = ThreadContextClassLoaderSupport.install(<b>new</b> TaggedClassLoader(&quot;test1&quot;));
        }

        <b>static void</b> uninstall() {
            memento.revert();
        }
    }</pre></div>
    

    
<p>We can then write some tests, assuming the existing of an appropriate class-loader class, and a method which
    can instantiate and serialize an instance, returning a byte array.</p>



    
<div class="source">
<pre>
    <i>@Before</i>
    <b>public void</b> setUp() <b>throws</b> Exception {
        ClassLoaderControl.install();
    }

    <i>@After</i>
    <b>public void</b> tearDown() {
        ClassLoaderControl.uninstall();
    }

    <i>@Test</i>
    <b>public void</b> whenTaggedClassRead_setProperty() {
        ThreadContextClassLoaderSupport.createStubInThreadContextClassLoader(&quot;my.Class&quot;, BaseClass.class);
        BaseClass in = (BaseClass) Thread.current.getContextClassLoader().loadClass(&quot;my.class&quot;);
        byte[] bytes = populateAndSerialize(base);

        BaseClass out = reader.read(new ByteArrayInputStream(bytes));

        assertThat(out.getApplicationName(), is(&quot;test1&quot;));
    }
</pre></div>


    
<p>while the <tt>Reader</tt> class is never given the classloader, and the instance is only found in the
        thread context classloader, the code now is able to read it, allowing us to test that behavior.</p>



</div>

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &copy; 2012-2019, Russell Gold. All Rights Reserved.
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>