<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.4 at 2016-07-14 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>SimpleStub - 
    SimpleStub: Handling Static Variables</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta name="Date-Revision-yyyymmdd" content="20160714" />
    <meta http-equiv="Content-Language" content="en" />
        
        </head>
  <body class="composite">
    <div id="banner">
                    <div id="bannerLeft">
                SimpleStub
                </div>
                    <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
            
                    
                <div class="xleft">
        <span id="publishDate">Last Published: 2016-07-14</span>
                  &nbsp;| <span id="projectVersion">Version: 1.2.6</span>
                      </div>
            <div class="xright">                    <a href="http://simplestub.java.net" class="externalLink" title="SimpleStub">SimpleStub</a>
              
                    
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
             
                    
                                <h5>Description</h5>
                  <ul>
                  <li class="none">
                          <a href="index.html" title="Overview">Overview</a>
            </li>
                  <li class="none">
                          <a href="started.html" title="Getting Started">Getting Started</a>
            </li>
                  <li class="none">
                          <a href="additional.html" title="Additional Use Cases">Additional Use Cases</a>
            </li>
                  <li class="none">
            <strong>Handling static variables</strong>
          </li>
                  <li class="none">
                          <a href="properties.html" title="Handling system properties">Handling system properties</a>
            </li>
                  <li class="none">
                          <a href="classloaders.html" title="Handling class loaders">Handling class loaders</a>
            </li>
                  <li class="none">
                          <a href="javassist.html" title="Using Javassist instead of ASM">Using Javassist instead of ASM</a>
            </li>
          </ul>
                       <h5>Project Documentation</h5>
                  <ul>
                                                                                                                                                                                                  <li class="collapsed">
                          <a href="project-info.html" title="Project Information">Project Information</a>
                  </li>
                                                                                                        <li class="collapsed">
                          <a href="project-reports.html" title="Project Reports">Project Reports</a>
                  </li>
          </ul>
                             <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
                   
                    
            </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">
        


<div class="section">
<h2>Handling Static Variables<a name="Handling_Static_Variables"></a></h2>


<p>Static variables can represent a bit of a challenge in unit testing. They are effectively global state, which
   means that we cannot always predict how they will change; in addition, they are typically private, which limits
   our ability to inject them into the SUT.
</p>

<p>Ultimately, we want to refactor our code to take any such values as injected dependencies; however, we need to
    start by testing the code as it exists. Java does allow us to cheat via reflection, and the usage tends to the same
    from test to test: preserve the old value, and replace it with a test value before the test, and then restore
    it afterwards. This is a common pattern, and the <tt>StaticStubSupport</tt> class exists to encapsulate that behavior.
</p>

<p>
    The following example tests some behavior of the <tt>Light</tt> class. After the system has been running for ten seconds, but not
    fewer, its <tt>isWarm()</tt> method should return true. Time since startup is determined by calling the <tt>getSecondsSinceStartup()</tt>
    of the <tt>Timer</tt> interface; however, the implementation of that interface is obtained by calling a static method:
    <tt>TimeManager.getTimer()</tt> which returns the static variable, <tt><i>timer</i></tt>, created by some other code during system startup.
</p>


<p>The first thing we do is to create an appropriate stub class:</p>

    
        
<div class="source">
<pre>
    <b>abstract static class</b> TimerStub <b>implements</b> Timer {
        <b>private long</b> secondsSinceStartup = 0;
        <b>private static</b> Memento memento = Memento.NULL;

        <b>static void</b> install() <b>throws</b> NoSuchFieldException {
            memento = StaticStubSupport.install(TimerManager.<b>class</b>, &quot;timer&quot;, createStub(TimerStub.<b>class</b>));
        }

        <b>static void</b> uninstall() {
            memento.revert();
        }

        <b>static void</b> setSecondsSinceStartup(<b>long</b> seconds) { secondsSinceStartup = seconds; }

        <i>@Override</i>
        <b>public long</b> getSecondsSinceStartup() { <b>return</b> secondsSinceStartup; }
    }</pre></div>
    

    
<p>In addition to providing a test implementation of our method, and a way to give it a value, we've also created a pair
       of methods to install and uninstall the stub itself, using StaticStubSupport. Now we can use this in a test:</p>


    
<div class="source">
<pre>
    <i>@Before</i>
    <b>public void</b> setUp() <b>throws</b> Exception {
        TimerStub.install();
    }

    <i>@After</i>
    <b>public void</b> tearDown() {
        TimerStub.uninstall();
    }

    <i>@Test</i>
    <b>public void</b> afterNineSeconds_lightNotWarm() {
        TimerStub.setSecondsSinceStartup(9);
        assertFalse(light.isWarm());
    }

    <i>@Test</i>
    <b>public void</b> afterTenSeconds_lightIsWarm() {
        TimerStub.setSecondsSinceStartup(10);
        assertTrue(light.isWarm());
    }</pre></div>
    

    
<p>thus verifying that the <tt>isMature</tt> method is reading the Timer and changing state once ten seconds have elapsed.</p>



</div>

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
              <?xml version="1.0" encoding="UTF-8"?>
<footer>Copyright Â© 2012-2016, Russell Gold. All Rights Reserved.</footer>
            </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>