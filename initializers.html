<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/xhtml/initializers.xhtml at 2024-01-23 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>SimpleStub &#x2013; SimpleStub: Testing Static Initialization</title>
    <style type="text/css" media="all">
      @import url("./css/maven-base.css");
      @import url("./css/maven-theme.css");
      @import url("./css/site.css");
    </style>
    <link rel="stylesheet" href="./css/print.css" type="text/css" media="print" />
    <meta http-equiv="Content-Language" content="en" />
    
  </head>
  <body class="composite">
    <div id="banner">
<div id="bannerLeft">
SimpleStub
</div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="breadcrumbs">
      <div class="xleft">
        <span id="publishDate">Last Published: 2024-01-23</span>
          &nbsp;| <span id="projectVersion">Version: 1.3.3</span>
      </div>
      <div class="xright"><a href="./" title="SimpleStub">SimpleStub</a>      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
    <div id="leftColumn">
      <div id="navcolumn">
       <h5>Description</h5>
    <ul>
     <li class="none"><a href="index.html" title="Overview">Overview</a></li>
     <li class="none"><a href="started.html" title="Getting Started">Getting Started</a></li>
     <li class="none"><a href="additional.html" title="Additional Use Cases">Additional Use Cases</a></li>
     <li class="none"><a href="statics.html" title="Handling static variables">Handling static variables</a></li>
     <li class="none"><a href="properties.html" title="Handling system properties">Handling system properties</a></li>
     <li class="none"><a href="classloaders.html" title="Handling class loaders">Handling class loaders</a></li>
     <li class="none"><a href="filesystem.html" title="Simulating files in memory">Simulating files in memory</a></li>
    </ul>
       <h5>Project Documentation</h5>
    <ul>
     <li class="collapsed"><a href="project-info.html" title="Project Information">Project Information</a></li>
     <li class="collapsed"><a href="project-reports.html" title="Project Reports">Project Reports</a></li>
    </ul>
      <a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy">
        <img class="poweredBy" alt="Built by Maven" src="./images/logos/maven-feather.png" />
      </a>
      </div>
    </div>
    <div id="bodyColumn">
      <div id="contentBox">



<div class="section">
<h2><a name="Testing_Static_Initialization"></a>Testing Static Initialization</h2>


<p>Some classes do static initialization based on the environment at startup. This can include system properties, classes
    on the classpath, the presence of specific files, and so on. These tend to be difficult to unit test, since
    the computation is done exactly once. Lazy initialization is often a better choice, but not everyone does that.
    To unit test such initializations, we need to reload the class, allowing it to run its initializations after
    the test has set up new conditions. The <tt>ClassLoadingSupport</tt> class exists to encapsulate that behavior.
</p>

<p>
    The unit test for <tt>ClassLoadingSupport</tt> shows how this works. The following class reads the current
    system properties when it is initialized.</p>

    
        
<div class="source">
<pre>
    <b>public class</b> PropertyReaderImpl <b>implements</b> PropertyReader {
        <b>private static final</b> Properties initialProperties;

        <b>static</b> {
            initialProperties = (Properties) System.getProperties().clone();
        }

        <i>@Override</i>
        <b>public</b> String getPropertyValue(String propertyName) {
            <b>return</b> initialProperties.getProperty(propertyName);
        }
    }</pre></div>
    

    
<p>Note that the <tt>getPropertyValue()</tt> method implements one defined on the interface. When we use this class
    in a test, it will initialize the <tt>initialProperties</tt> field only once, which limits us in testing it. But
    if we can reload it during the test, we can set new properties and have the class read them. </p>


    
<div class="source">
<pre>
    <b>private</b> List&lt;Memento&gt; mementos = <b>new</b> ArrayList&lt;Memento&gt;();

    <i>@After</i>
    <b>public void</b> tearDown() <b>throws</b> Exception {
        <b>for</b> (Memento memento : mementos)
            memento.revert();
        }
    }

    <i>@Test
    @SuppressWarnings(&quot;all&quot;)</i>
    <b>public void</b> testClassReloading() <b>throws</b> Exception {
(1)     mementos.add(SystemPropertySupport.install(&quot;test.property&quot;, &quot;zork&quot;));
(2)     Class reloadedClass = ClassLoadingSupport.reloadClass(PropertyReaderImpl.class);
(3)     PropertyReader secondReader = (PropertyReader) reloadedClass.newInstance();
(4)     assertThat(secondReader.getPropertyValue(&quot;test.property&quot;), is(&quot;zork&quot;));
    }</pre></div>
    


<p>The test will:</p>
    
<ol style="list-style-type: decimal">
    	
<li>use the <tt>SystemPropertySupport</tt> class to set a system property in our environment (it will be reverted
    	    by the <tt>tearDown</tt> method after the test completes.</li>
    	
<li>reload the <tt>PropertyReaderImpl</tt> class in its own classloader. This causes the static initializers to run.</li>
    	
<li>create an instance of the new class. Since its classloader inherits from the original, we can cast it to the interface.</li>
    	
<li>verify that the static value set during initialization is based on the new property value.</li>
    </ol>


<p>Our new class is garbage collected when the test is over.</p>


</div>

      </div>
    </div>
    <div class="clear">
      <hr/>
    </div>
    <div id="footer">
      <div class="xright">
        Copyright &copy; 2012-2019, Russell Gold. All Rights Reserved.
      </div>
      <div class="clear">
        <hr/>
      </div>
    </div>
  </body>
</html>